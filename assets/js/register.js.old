document.addEventListener('DOMContentLoaded', function() {
    console.log("üîÑ P√°gina de registro carregada");
    initRegisterPage();
});

function initRegisterPage() {
    const registerForm = document.getElementById('registerForm');
    
    if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
        console.log("‚úÖ Event listener do registro adicionado");
    }
}

function handleRegister(event) {
    event.preventDefault();
    
    // üìù Capturar TODOS os campos
    const name = document.getElementById('name').value.trim();
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('ia-password').value;
    const confirmPassword = document.getElementById('ia-confirm-password').value;
    const cpf = document.getElementById('cpf').value.trim();
    const phone = document.getElementById('telefone').value.trim();
    const email = document.getElementById('email').value.trim();
    
    console.log("üìù Dados capturados:", {
        name, username, email, phone, cpf: cpf ? "***" : "vazio"
    });
    
    // ‚úÖ Valida√ß√µes no frontend
    if (!name) {
        showError("Nome completo √© obrigat√≥rio!");
        return;
    }
    
    if (!username) {
        showError("Nome de usu√°rio √© obrigat√≥rio!");
        return;
    }
    
    if (!password) {
        showError("Senha √© obrigat√≥ria!");
        return;
    }
    
    if (!confirmPassword) {
        showError("Confirma√ß√£o de senha √© obrigat√≥ria!");
        return;
    }
    
    if (!phone) {
        showError("Telefone √© obrigat√≥rio!");
        return;
    }
    
    if (!email) {
        showError("Email √© obrigat√≥rio!");
        return;
    }
    
    if (password !== confirmPassword) {
        showError("As senhas n√£o coincidem!");
        return;
    }
    
    if (password.length < 6) {
        showError("Senha deve ter pelo menos 6 caracteres!");
        return;
    }
    
    if (!isValidEmail(email)) {
        showError("Digite um email v√°lido!");
        return;
    }
    
    if (!isValidPhone(phone)) {
        showError("Digite um telefone v√°lido! Ex: (11) 99999-9999");
        return;
    }
    
    // üîÑ Desabilitar bot√£o durante processo
    const submitBtn = document.querySelector('button[type="submit"]');
    submitBtn.disabled = true;
    submitBtn.textContent = "Registrando...";
    
    // üöÄ Aguardar ponte estar pronta
    if (window.UnifiedBridge && window.UnifiedBridge.isReady()) {
        // Ponte j√° est√° pronta
        window.UnifiedBridge.register(username, password, email, name, phone, cpf);
    } else {
        // Aguardar ponte ficar pronta
        document.addEventListener('bridgeReady', function() {
            window.UnifiedBridge.register(username, password, email, name, phone, cpf);
        });
    }
}

// üîß Fun√ß√µes de valida√ß√£o
function isValidEmail(email) {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(email);
}

function isValidPhone(phone) {
    // Remove caracteres n√£o num√©ricos
    const cleanPhone = phone.replace(/\D/g, '');
    // Telefone brasileiro: 10 ou 11 d√≠gitos
    return cleanPhone.length >= 10 && cleanPhone.length <= 11;
}

function showError(message) {
    const errorElement = document.getElementById('errorMessage');
    if (errorElement) {
        errorElement.textContent = message;
        errorElement.style.display = "block";
        
        setTimeout(() => {
            errorElement.style.display = "none";
        }, 5000);
    }
}

function resetRegisterButton() {
    const submitBtn = document.querySelector('button[type="submit"]');
    if (submitBtn) {
        submitBtn.disabled = false;
        submitBtn.textContent = "Registrar";
    }
}

// üì• Callback para sucesso (chamado pelo Python)
function registerResult(success, message) {
    console.log("üì• Resultado do registro:", {success, message});
    
    resetRegisterButton();
    
    if (success) {
        alert("Registro realizado com sucesso! Voc√™ ser√° redirecionado para a p√°gina de login.");
        goToLogin();
    } else {
        showError(message);
    }
}